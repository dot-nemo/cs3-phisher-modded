# Generated by OpenAI o4-mini on 16-05-2025
name: Daily Sync with Upstream

on:
  schedule:
    # 08:00 Asia/Manila (UTC+8) → 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

env:
  UPSTREAM_REPO: https://github.com/phisher98/cloudstream-extensions-phisher.git
  BASE_BRANCH: master
  SYNC_BRANCH: sync-upstream

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.BASE_BRANCH }}

      - name: Configure Git
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add & fetch upstream
        run: |
          git remote add upstream $UPSTREAM_REPO || true
          git fetch upstream

      - name: Create or reset sync branch
        run: |
          # Create sync branch if needed, or reset it to BASE_BRANCH
          git checkout -B $SYNC_BRANCH origin/${{ env.BASE_BRANCH }}

      - name: Merge upstream/${{ env.BASE_BRANCH }}
        run: |
          git merge upstream/${{ env.BASE_BRANCH }} --no-edit || true

      - name: Auto-resolve delete/modify (keep deletions)
        run: |
          git diff --name-status --diff-filter=UD \
            | awk '{print $2}' \
            | while read file; do
                git rm "$file"
              done

      - name: Check for remaining changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Exit if no new changes
        if: steps.changes.outputs.no_changes == 'true'
        run: echo "No upstream updates to sync; exiting."

      - name: Commit & force-push sync branch
        if: steps.changes.outputs.no_changes == 'false'
        run: |
          git commit -am "chore(sync): upstream sync $(date -u +'%Y-%m-%d')"
          git push -f origin ${{ env.SYNC_BRANCH }}

      - name: Create or update Pull Request
        if: steps.changes.outputs.no_changes == 'false'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(sync): upstream sync $(date -u +'%Y-%m-%d')"
          branch: ${{ env.SYNC_BRANCH }}
          base: ${{ env.BASE_BRANCH }}
          title: "Automated upstream sync"
          body: |
            This PR was automatically generated to sync in changes from the upstream repository.
            Any files you’d previously deleted (and that were modified upstream) have been left deleted.
          labels: automated, sync
